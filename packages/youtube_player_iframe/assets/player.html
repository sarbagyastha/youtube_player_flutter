<!-- Template file with placeholders like <<playerId>> that are replaced at runtime -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <style>
      html {
        width: 100%;
        height: 100%;
        background-color: black;
        pointer-events: <<pointerEvents>>;
      }

      body {
        margin: 0;
        width: 100%;
        height: 100%;
        background-color: black;
        pointer-events: inherit;
      }

      .embed-container iframe,
      .embed-container object,
      .embed-container embed {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        pointer-events: inherit;
      }
    </style>
    <title>Youtube Player</title>
  </head>

  <body>
    <div class="embed-container">
      <div id="<<playerId>>"></div>
    </div>

    <script>
      var tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var platform = "<<platform>>";
      var host = "<<host>>";
      var player;
      var timerId;
      var isPlayerReady = false;
      var isDisposed = false;

      // Cleanup function
      function cleanup() {
        if (timerId) {
          clearTimeout(timerId);
          timerId = null;
        }

        if (player && typeof player.destroy === 'function') {
          try {
            player.destroy();
          } catch (e) {
            console.warn('Error destroying player:', e);
          }
        }

        isPlayerReady = false;
        isDisposed = true;
      }

      // Enhanced error handling
      function safePlayerCall(func, ...args) {
        if (isDisposed || !isPlayerReady || !player) {
          return null;
        }

        try {
          return func.apply(player, args);
        } catch (e) {
          console.warn('Player call failed:', e);
          return null;
        }
      }

      function onYouTubeIframeAPIReady() {
        if (isDisposed) return;

        try {
          player = new YT.Player("<<playerId>>", {
            host: host,
            playerVars: <<playerVars>>,
            events: {
              onReady: function (event) {
                isPlayerReady = true;
                handleFullScreenForMobilePlatform();
                sendMessage('Ready', event);
              },
              onStateChange: function (event) {
                if (isDisposed) return;

                clearTimeout(timerId);
                sendMessage('StateChange', event.data);

                if (event.data == 1) { // Playing state
                  timerId = setInterval(function () {
                    if (isDisposed || !isPlayerReady) {
                      clearTimeout(timerId);
                      return;
                    }

                    try {
                      var state = {
                        'currentTime': safePlayerCall(player.getCurrentTime) || 0,
                        'loadedFraction': safePlayerCall(player.getVideoLoadedFraction) || 0
                      };

                      sendMessage('VideoState', JSON.stringify(state));
                    } catch (e) {
                      console.warn('Error getting video state:', e);
                      clearTimeout(timerId);
                    }
                  }, 100);
                }
              },
              onPlaybackQualityChange: function (event) {
                if (!isDisposed) sendMessage('PlaybackQualityChange', event.data);
              },
              onPlaybackRateChange: function (event) {
                if (!isDisposed) sendMessage('PlaybackRateChange', event.data);
              },
              onApiChange: function (event) {
                if (!isDisposed) sendMessage('ApiChange', event.data);
              },
              onError: function (event) {
                if (!isDisposed) sendMessage('PlayerError', event.data);
              },
              onAutoplayBlocked: function (event) {
                if (!isDisposed) sendMessage('AutoplayBlocked', event.data);
              },
            },
          });

          // Set initial size safely
          safePlayerCall(player.setSize, window.innerWidth, window.innerHeight);
        } catch (e) {
          console.error('Error initializing YouTube player:', e);
          sendMessage('PlayerError', 100); // Send generic error
        }
      }

      window.addEventListener('message', (event) => {
        if (isDisposed) return;

        try {
          var data = JSON.parse(event.data);

          if(data.function){
            var rawFunction = data.function.replaceAll('<<quote>>', '"');
            var result = eval(rawFunction);

            if(data.key) {
              var message = {}
              message[data.key] = result
              var messageString = JSON.stringify(message);

              event.source.postMessage(messageString , '*');
            }
          }
        } catch (e) {
          console.warn('Error processing message:', e);
        }
      }, false);

      window.addEventListener('beforeunload', cleanup);

      window.onresize = function () {
        if (!isDisposed && isPlayerReady) {
          safePlayerCall(player.setSize, window.innerWidth, window.innerHeight);
        }
      };

      function sendPlatformMessage(message) {
        if (isDisposed) return;

        try {
          switch(platform) {
             case 'android':
               <<playerId>>.postMessage(message);
               break;
             case 'ios':
               <<playerId>>.postMessage(message, '*');
               break;
             case 'web':
               window.parent.postMessage(message, '*');
               break;
           }
        } catch (e) {
          console.warn('Error sending platform message:', e);
        }
      }

      function sendMessage(key, data) {
        if (isDisposed) return;

        try {
          var message = {};
          message[key] = data;
          message['playerId'] = '<<playerId>>';
          var messageString = JSON.stringify(message);

          sendPlatformMessage(messageString);
        } catch (e) {
          console.warn('Error sending message:', e);
        }
      }

      function getVideoData() {
        return prepareDataForPlatform(safePlayerCall(player.getVideoData) || {});
      }

      function getPlaylist() {
        return prepareDataForPlatform(safePlayerCall(player.getPlaylist) || []);
      }

      function getAvailablePlaybackRates(){
        return prepareDataForPlatform(safePlayerCall(player.getAvailablePlaybackRates) || []);
      }

      function prepareDataForPlatform(data) {
        if (isDisposed) return platform == 'android' ? {} : '{}';

        try {
          if(platform == 'android') return data;
          return JSON.stringify(data);
        } catch (e) {
          console.warn('Error preparing data for platform:', e);
          return platform == 'android' ? {} : '{}';
        }
      }

      function handleFullScreenForMobilePlatform() {
        if(platform != 'web' && isPlayerReady && !isDisposed) {
          try {
            var ytFrame = document.getElementsByTagName('iframe')[0].contentWindow.document;
            var fsButton = ytFrame.getElementsByClassName('ytp-fullscreen-button ytp-button')[0];

            if(fsButton != null) {
              var fsButtonCopy = fsButton.cloneNode(true);
              fsButton.replaceWith(fsButtonCopy);
              fsButtonCopy.onclick = function() {
                sendMessage('FullscreenButtonPressed', '');
              };
            }
          } catch (e) {
            // Fullscreen button handling may fail in some cases, ignore silently
          }
        }
      }
    </script>
  </body>
</html>
